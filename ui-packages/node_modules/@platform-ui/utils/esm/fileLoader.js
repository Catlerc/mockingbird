/* eslint-disable import/no-commonjs, global-require */
const listLoaders = Object.create(null);
let fileLoader;

if (process.env.SERVER) {
  fileLoader = url => {
    const fetch = require('node-fetch').default; // возможны url без протокола - //some.site - заменяем на протокол http для корректного
    // парсинга


    const fixedUrl = url.replace(/^\/\//, 'http://');
    listLoaders[url] = listLoaders[url] || fetch(fixedUrl, {
      timeout: 2000
    }).then(res => {
      if (res.status !== 200) {
        throw new Error(`Status code is ${res.status} - ${res.statusText} for ${url}`);
      }

      return res.text();
    }).catch(err => {
      listLoaders[url] = undefined;
      throw err;
    });
    return listLoaders[url];
  };
} else {
  fileLoader = url => {
    listLoaders[url] = listLoaders[url] || new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url);

      xhr.onload = function onload() {
        if (this.status >= 200 && this.status < 300) {
          resolve(xhr.response);
        } else {
          reject({
            status: this.status,
            statusText: xhr.statusText
          });
        }

        listLoaders[url] = undefined;
      };

      xhr.onerror = function onerror() {
        reject({
          status: this.status,
          statusText: xhr.statusText
        });
        listLoaders[url] = undefined;
      };

      xhr.send();
    });
    return listLoaders[url];
  };
}

export default (url => {
  return fileLoader(url);
});